<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de Contratos — DOCX (compat templates {{CHAVE}})</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PizZip para abrir/zipar DOCX -->
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.7/dist/pizzip.min.js"></script>

  <!-- Confetti (efeito) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <!-- Lucide Icons (UMD: expõe window.lucide) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <style>
    .progress-striped {
      background-image: linear-gradient(45deg, rgba(255,255,255,.25) 25%,
        transparent 25%, transparent 50%, rgba(255,255,255,.25) 50%,
        rgba(255,255,255,.25) 75%, transparent 75%, transparent);
      background-size: 1rem 1rem;
      animation: progress 1s linear infinite;
    }
    @keyframes progress { from{background-position:1rem 0} to{background-position:0 0} }

    .card-hover { transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease; }
    .card-hover:hover {
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 10px 24px rgba(0,0,0,0.10);
      border-color: rgb(30 41 59 / 0.20);
    }
    .selected-card {
      transform: translateY(-2px) scale(1.012);
      box-shadow: 0 22px 44px -14px rgba(0,0,0,0.28), 0 6px 14px rgba(0,0,0,0.06);
      border-color: rgb(15 23 42 / 0.35);
    }

    /* Accordion */
    .acc-item{border-radius:1rem;border:1px solid rgb(226 232 240);overflow:hidden}
    .acc-header{width:100%;text-align:left;padding:0.875rem 1rem;display:flex;align-items:center;justify-content:space-between}
    .acc-body{padding:0.75rem 1rem 1rem 1rem;border-top:1px dashed rgb(226 232 240)}
  </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased min-h-screen">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold">Gerador de Contratos</h1>
      <div class="text-sm text-gray-500">Mantém templates com {{CHAVE}}</div>
    </header>

    <!-- Empresas -->
    <section class="grid md:grid-cols-2 gap-4">
      <!-- Inova Inox -->
      <button data-company="InovaInox"
              class="company-card card-hover rounded-2xl bg-white shadow border p-6 text-left w-full">
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 text-gray-700">
            <i data-lucide="building-2" class="w-6 h-6"></i>
            <i data-lucide="drill" class="w-6 h-6"></i>
          </div>
          <div>
            <div class="font-semibold text-lg leading-tight">Inova Inox</div>
            <div class="text-gray-500 text-sm leading-tight">Contrato, OS e Capa</div>
          </div>
        </div>
      </button>

      <!-- Porto Stone (mantido, mas você pode ignorar) -->
      <button data-company="PortoStone"
              class="company-card card-hover rounded-2xl bg-white shadow border p-6 text-left w-full">
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 text-gray-700">
            <i data-lucide="building-2" class="w-6 h-6"></i>
            <i data-lucide="hammer" class="w-6 h-6"></i>
          </div>
          <div>
            <div class="font-semibold text-lg leading-tight">Porto Stone</div>
            <div class="text-gray-500 text-sm leading-tight">Contrato e OS</div>
          </div>
        </div>
      </button>
    </section>

    <!-- Config -->
    <section id="step-config" class="hidden mt-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <button id="btn-back" class="text-sm px-3 py-1.5 rounded-lg border">← Voltar</button>
          <h2 class="text-xl font-semibold"><span id="label-company"></span></h2>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-4">
        <!-- Coluna esquerda: seleção de documentos -->
        <div class="rounded-2xl bg-white shadow border p-5">
          <div class="font-medium mb-3">Documentos</div>
          <div id="doc-options" class="space-y-2 text-sm"></div>
          <p class="text-xs text-gray-500 mt-3">
            Placeholders de texto: <b>{{CHAVE}}</b>.<br>
            Placeholders de imagens (ex.: <code>{{DESENHO1}}</code>, <code>{{FOTO_ORÇAMENTO}}</code>) serão removidos do corpo e as imagens anexadas no final.
          </p>
        </div>

        <!-- Coluna central: campos organizados por categorias -->
        <div class="rounded-2xl bg-white shadow border p-5 lg:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <div class="font-medium">Campos</div>
            <input id="filter-input" placeholder="Filtrar campo/CHAVE..." class="rounded-xl border px-3 py-2 text-sm w-60">
          </div>

          <div id="accordion" class="space-y-3"></div>

          <div class="mt-5">
            <div class="font-medium mb-1">Imagens (opcional)</div>
            <input id="foto-input" type="file" accept="image/*" multiple class="block w-full text-sm border rounded-xl px-3 py-2" />
            <p class="text-xs text-gray-500 mt-1">Serão inseridas numa nova página ao final.</p>
          </div>

          <div class="mt-5">
            <div class="flex items-center justify-between">
              <div class="font-medium">Campos personalizados</div>
              <button id="add-custom" class="text-sm px-3 py-1.5 rounded-lg border">+ Adicionar</button>
            </div>
            <div id="custom-fields" class="mt-2 space-y-2"></div>
          </div>

          <div class="flex items-center justify-end gap-3 mt-6">
            <button id="btn-generate" class="px-5 py-2.5 rounded-xl bg-black text-white">Gerar DOCX</button>
          </div>
        </div>
      </div>

      <!-- Painel de prévia -->
      <div class="mt-6 rounded-2xl bg-white shadow border p-5">
        <div class="font-medium">Prévia de substituições</div>
        <div id="preview" class="mt-2 text-sm grid md:grid-cols-2 gap-x-6 gap-y-1"></div>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-400 mt-10">
      Mantém seus DOCX com {{CHAVE}}. Sem dependência de módulo de imagem.
    </footer>
  </div>

  <!-- Modal de progresso -->
  <div id="progress-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
      <div class="flex items-center gap-3 mb-3">
        <div class="h-10 w-10 rounded-full bg-black text-white grid place-items-center font-semibold">%</div>
        <div>
          <h3 class="text-lg font-semibold">Gerando documento…</h3>
          <p id="progress-msg" class="text-xs text-gray-500">Preparando…</p>
        </div>
      </div>
      <div class="w-full h-3 rounded-full bg-gray-200 overflow-hidden">
        <div id="progress-bar" class="h-full w-0 bg-black progress-striped"></div>
      </div>
      <div class="text-right text-sm mt-2"><span id="progress-num">0</span>%</div>
      <div id="fallback-link" class="hidden mt-4 text-center">
        <a id="manual-link" class="text-black underline font-medium" href="#" download>Se não baixou, clique aqui para baixar</a>
      </div>
      <div id="diag" class="mt-4 hidden">
        <details class="text-xs text-gray-600">
          <summary class="cursor-pointer font-medium">Diagnóstico</summary>
          <div class="mt-2 space-y-2" id="diag-content"></div>
        </details>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 top-6 hidden z-[60]">
    <div class="px-4 py-2 bg-white shadow-lg rounded-xl border flex items-center gap-2">
      <span>✅ Documento gerado!</span>
    </div>
  </div>

  <script>
    // ===== Util: formatar/parsear BRL e por extenso =====
    const fmtBRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const formatBRL = (n) => fmtBRL.format(isFinite(n) ? n : 0);
    const parseBRL = (s) => {
      if (typeof s !== 'string') return Number(s) || 0;
      const clean = s.replace(/\s/g,'').replace(/\./g,'').replace(',', '.').replace(/[^\d.-]/g,'');
      const n = parseFloat(clean);
      return isNaN(n) ? 0 : n;
    };

    // Conversor simples pt-BR (até trilhões) para moeda (reais/centavos)
    function numeroPorExtensoBRL(valor) {
      const unidades = ['','um','dois','três','quatro','cinco','seis','sete','oito','nove'];
      const onzeDezenove = ['onze','doze','treze','quatorze','quinze','dezesseis','dezessete','dezoito','dezenove'];
      const dezenas = ['','dez','vinte','trinta','quarenta','cinquenta','sessenta','setenta','oitenta','noventa'];
      const centenas = ['','cento','duzentos','trezentos','quatrocentos','quinhentos','seiscentos','setecentos','oitocentos','novecentos'];
      const classes = [
        {sing:'', plur:''},
        {sing:'mil', plur:'mil'},
        {sing:'milhão', plur:'milhões'},
        {sing:'bilhão', plur:'bilhões'},
        {sing:'trilhão', plur:'trilhões'},
      ];
      const inteiro = Math.floor(Math.abs(valor));
      const cent = Math.round((Math.abs(valor) - inteiro) * 100);

      const tres = (n) => {
        if (n === 0) return '';
        if (n === 100) return 'cem';
        let c = Math.floor(n/100), d = Math.floor((n%100)/10), u = n%10;
        let out = [];
        if (c) out.push(centenas[c]);
        if (d === 1 && u > 0) out.push(onzeDezenove[u-1]);
        else {
          if (d) out.push(dezenas[d]);
          if (u) out.push(unidades[u]);
        }
        return out.join(' e ');
      };

      const toGroups = (n) => {
        const s = n.toString().padStart(Math.ceil(n.toString().length/3)*3, '0');
        const arr = [];
        for (let i=0;i<s.length;i+=3) arr.push(Number(s.slice(i,i+3)));
        return arr;
      };

      const grupos = toGroups(inteiro);
      let partes = [];
      grupos.forEach((g, idx) => {
        const pos = grupos.length - 1 - idx;
        const t = tres(g);
        if (!t) return;
        const nome = classes[pos] || classes[classes.length-1];
        if (pos === 0) partes.push(t);
        else if (g === 1) partes.push(t + (nome.sing ? ' ' + nome.sing : ''));
        else partes.push(t + ' ' + nome.plur);
      });

      let reais = partes.join(', ').replace(/, ([^,]*)$/, ' e $1');
      if (!reais) reais = 'zero';
      reais += (inteiro === 1 ? ' real' : ' reais');

      let centavos = '';
      if (cent > 0) {
        const t = tres(cent);
        centavos = (t || 'zero') + (cent === 1 ? ' centavo' : ' centavos');
      }

      return centavos ? (reais + ' e ' + centavos) : reais;
    }

    // ===== Config =====
    const DOCS = {
      InovaInox: ['Contrato', 'Ordem_de_Servico', 'Capa'],
      PortoStone: ['Contrato', 'Ordem_de_Servico'],
    };

    // Campos comuns
    const COMMON_FIELDS = [
      { key: 'NOME_CONTRATANTE', label: 'Nome do cliente' },
      { key: 'CPF_CONTRATANTE', label: 'CPF/CNPJ' },
      { key: 'TELEFONE_CONTRATANTE', label: 'Telefone' },
      { key: 'ENDERECO_CONTRATANTE', label: 'Endereço' },
      { key: 'TIPO_DE_PROJETO', label: 'Tipo de projeto' },
      { key: 'DATA_EMISSAO_CONTRATO', label: 'Data de emissão (auto)', placeholder: 'auto' },

      // Financeiro compartilhado (para facilitar)
      { key: 'VALOR_PRODUTOS_INSTALACAO', label: 'Valor de produtos + instalação', type: 'money' },
      { key: 'VALOR_DESCONTO', label: 'Desconto acordado', type: 'money' },

      // Calculados automaticamente (somente leitura na UI)
      { key: 'VALOR_TOTAL', label: 'Valor total (auto)', type: 'money-readonly' },
      { key: 'VALOR_TOTAL_POR_EXTENSO', label: 'Valor total por extenso (auto)', type: 'textarea-readonly' },
    ];

    // Campos específicos por documento
    const FIELDS_BY_DOC = {
      InovaInox: {
        Contrato: [
          { key: 'NÚMERO_PARCELAS', label: 'Número de parcelas' },
          { key: 'VALOR_PARCELAS', label: 'Valor das parcelas', type: 'money' },
          { key: 'VALOR_PARCELAS_POR_EXTENSO', label: 'Valor das parcelas (por extenso)', type: 'textarea' },
          { key: 'FORMA_PAGAMENTO_PARCELAS', label: 'Forma de pagamento das parcelas' },
        ],
        Ordem_de_Servico: [
          { key: 'ORDEM_PRODUCAO', label: 'Ordem de Produção' },
          { key: 'CIDADE', label: 'Cidade' },
          { key: 'VENDEDOR', label: 'Vendedor' },
        ],
        Capa: [
          { key: 'ORDEM_PRODUCAO', label: 'Ordem de Produção' },
          { key: 'ENDERECO_CONTRATANTE_PROJETO', label: 'Endereço do projeto (obra)' },
        ],
      },
      PortoStone: {
        Contrato: [],
        Ordem_de_Servico: [{ key: 'ORDEM_PRODUCAO', label: 'Ordem de Produção' }],
      },
    };

    const IMAGE_KEY_HINT = /(DESENHO|FOTO)/i;
    const el  = (s) => document.querySelector(s);
    const els = (s) => Array.from(document.querySelectorAll(s));
    const wrapKey = (k) => `{{${k}}}`;

    // Inicializa Lucide
    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide && lucide.createIcons) lucide.createIcons();
    });

    // ===== Navegação =====
    let currentCompany = null;

    function selectCompanyCard(btn) {
      els('.company-card').forEach(b => b.classList.remove('selected-card'));
      btn.classList.add('selected-card');
    }

    els('.company-card').forEach((btn) => {
      btn.addEventListener('click', () => {
        currentCompany = btn.dataset.company;
        selectCompanyCard(btn);
        el('#label-company').textContent = currentCompany === 'InovaInox' ? 'Inova Inox' : 'Porto Stone';
        renderDocOptions();
        renderAccordion();
        el('#step-config').classList.remove('hidden');
      });
    });

    el('#btn-back').addEventListener('click', () => location.reload());

    function renderDocOptions() {
      const wrap = el('#doc-options'); wrap.innerHTML = '';
      DOCS[currentCompany].forEach((name) => {
        const isChecked = name === 'Contrato' ? 'checked' : '';
        wrap.insertAdjacentHTML('beforeend', `
          <label class="flex items-center gap-2">
            <input type="checkbox" class="accent-black doc-check" id="doc-${name}" ${isChecked} />
            <span>${name.replace(/_/g,' ')}</span>
          </label>`);
      });
      els('.doc-check').forEach((c) => c.addEventListener('change', () => {
        renderAccordion();
      }));
    }

    function getActiveDocs() {
      return (DOCS[currentCompany] || []).filter((name) => el('#doc-' + name)?.checked);
    }

    function getAllFieldsGrouped() {
      const active = getActiveDocs();

      // Agrupamento base
      const groups = {
        identificacao: { title: 'Identificação do cliente', fields: [] },
        endereco: { title: 'Endereço', fields: [] },
        projeto: { title: 'Projeto', fields: [] },
        financeiro: { title: 'Financeiro', fields: [] },
        comercial: { title: 'Comercial / Operacional (OS)', fields: [] },
        personalizados: { title: 'Campos personalizados', fields: [] }, // UI separada
      };

      // Distribui COMMON_FIELDS
      COMMON_FIELDS.forEach(f => {
        if (['NOME_CONTRATANTE','CPF_CONTRATANTE','TELEFONE_CONTRATANTE'].includes(f.key)) groups.identificacao.fields.push(f);
        else if (['ENDERECO_CONTRATANTE'].includes(f.key)) groups.endereco.fields.push(f);
        else if (['TIPO_DE_PROJETO','DATA_EMISSAO_CONTRATO'].includes(f.key)) groups.projeto.fields.push(f);
        else if (['VALOR_PRODUTOS_INSTALACAO','VALOR_DESCONTO','VALOR_TOTAL','VALOR_TOTAL_POR_EXTENSO'].includes(f.key)) groups.financeiro.fields.push(f);
      });

      // Campos específicos conforme documentos ativos
      active.forEach(doc => {
        (FIELDS_BY_DOC[currentCompany]?.[doc] || []).forEach(f => {
          if (doc === 'Capa' && f.key === 'ENDERECO_CONTRATANTE_PROJETO') groups.endereco.fields.push(f);
          else if (['ORDEM_PRODUCAO'].includes(f.key) || f.key === 'ENDERECO_CONTRATANTE_PROJETO') groups.projeto.fields.push(f);
          else if (doc === 'Ordem_de_Servico') groups.comercial.fields.push(f);
          else if (doc === 'Contrato') groups.financeiro.fields.push(f);
        });
      });

      // Remove duplicados por key
      for (const g of Object.values(groups)) {
        const seen = new Set();
        g.fields = g.fields.filter(f => !seen.has(f.key) && seen.add(f.key));
      }

      // Condicional: só mostra Financeiro quando Contrato ativo
      if (!active.includes('Contrato')) groups.financeiro.fields = groups.financeiro.fields
        .filter(f => !['VALOR_PRODUTOS_INSTALACAO','VALOR_DESCONTO','VALOR_TOTAL','VALOR_TOTAL_POR_EXTENSO','NÚMERO_PARCELAS','VALOR_PARCELAS','VALOR_PARCELAS_POR_EXTENSO','FORMA_PAGAMENTO_PARCELAS'].includes(f.key));

      // Condicional: só mostra Comercial quando OS ativo
      if (!active.includes('Ordem_de_Servico')) groups.comercial.fields = [];

      return groups;
    }

    function fieldInput({ key, label, type='text', placeholder='' }) {
      const id = 'f-' + key;
      const commonLabel = `<label for="${id}" class="text-sm font-medium">${label} <span class="text-gray-400 text-xs">(${key})</span></label>`;

      if (type === 'textarea' || type === 'textarea-readonly') {
        return `<div class="flex flex-col gap-1">
          ${commonLabel}
          <textarea id="${id}" data-key="${key}" rows="2" class="mt-1 w-full rounded-xl border px-3 py-2 ${type==='textarea-readonly'?'bg-gray-50 text-gray-700':''}" ${type==='textarea-readonly'?'readonly':''}></textarea>
        </div>`;
      }

      if (type === 'money' || type === 'money-readonly') {
        return `<div class="flex flex-col gap-1">
          ${commonLabel}
          <input id="${id}" data-key="${key}" inputmode="decimal" class="mt-1 w-full rounded-xl border px-3 py-2 ${type==='money-readonly'?'bg-gray-50 text-gray-700':''}" ${type==='money-readonly'?'readonly':''} />
        </div>`;
      }

      return `<div class="flex flex-col gap-1">
        ${commonLabel}
        <input id="${id}" data-key="${key}" placeholder="${placeholder}" class="mt-1 w-full rounded-xl border px-3 py-2" />
      </div>`;
    }

    function renderAccordion() {
      const wrap = el('#accordion'); wrap.innerHTML = '';
      const groups = getAllFieldsGrouped();
      const order = ['identificacao','endereco','projeto','financeiro','comercial'];
      order.forEach((key, idx) => {
        const g = groups[key];
        if (!g.fields.length) return;
        const bodyId = `acc-body-${key}`;
        const count = g.fields.length;
        wrap.insertAdjacentHTML('beforeend', `
          <div class="acc-item">
            <button class="acc-header" data-target="${bodyId}">
              <span class="font-medium">${g.title} <span class="text-xs text-gray-500">(${count})</span></span>
              <i data-lucide="chevron-down" class="w-5 h-5"></i>
            </button>
            <div id="${bodyId}" class="acc-body ${idx ? 'hidden' : ''}">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                ${g.fields.map(f => fieldInput(f)).join('')}
              </div>
            </div>
          </div>
        `);
      });

      // Accordion toggle
      els('.acc-header').forEach(h => {
        h.addEventListener('click', () => {
          const id = h.dataset.target;
          el('#'+id).classList.toggle('hidden');
        });
      });

      // Bind money formatters e cálculo automático
      bindMoneyHandlers();
      updateCalculatedFields();
      refreshPreview();
      installFilter();
    }

    function bindMoneyHandlers() {
      // Formatar on-blur e recálculo on-input
      ['VALOR_PRODUTOS_INSTALACAO','VALOR_DESCONTO','VALOR_PARCELAS'].forEach(k => {
        const inp = el('#f-' + k);
        if (!inp) return;
        inp.addEventListener('input', () => {
          // não formatamos em tempo real para não atrapalhar digitação — só recalculamos
          updateCalculatedFields();
          refreshPreview();
        });
        inp.addEventListener('blur', () => {
          const n = parseBRL(inp.value);
          inp.value = n ? formatBRL(n) : '';
          updateCalculatedFields();
          refreshPreview();
        });
      });
    }

    function updateCalculatedFields() {
      const vProdutos = parseBRL(el('#f-VALOR_PRODUTOS_INSTALACAO')?.value || '');
      const vDesc = parseBRL(el('#f-VALOR_DESCONTO')?.value || '');
      const total = Math.max(0, (vProdutos || 0) - (vDesc || 0));

      const totalEl = el('#f-VALOR_TOTAL');
      if (totalEl) totalEl.value = total ? formatBRL(total) : '';

      const extensoEl = el('#f-VALOR_TOTAL_POR_EXTENSO');
      if (extensoEl) extensoEl.value = total ? numeroPorExtensoBRL(total) : '';
    }

    function installFilter() {
      const fi = el('#filter-input');
      if (!fi || fi._bound) return;
      fi._bound = true;
      fi.addEventListener('input', () => {
        const q = (fi.value || '').trim().toLowerCase();
        els('[data-key]').forEach(n => {
          const key = n.dataset.key.toLowerCase();
          const label = (n.closest('div')?.querySelector('label')?.textContent || '').toLowerCase();
          const show = !q || key.includes(q) || label.includes(q);
          n.closest('.flex.flex-col')?.classList.toggle('hidden', !show);
        });
      });
    }

    // ===== Custom fields =====
    el('#add-custom').addEventListener('click', () => {
      el('#custom-fields').insertAdjacentHTML('beforeend', `
        <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
          <input placeholder="Chave (ex.: {{NOME_CONTRATANTE}})" data-type="custom-key" class="col-span-2 rounded-xl border px-3 py-2" />
          <input placeholder="Valor" data-type="custom-val" class="md:col-span-3 rounded-xl border px-3 py-2" />
        </div>`);
    });

    // ===== Progress / Toast / Diag =====
    function showProgress(show = true) {
      const m = el('#progress-modal');
      if (show) { m.classList.remove('hidden'); m.style.display = 'flex'; }
      else { m.classList.add('hidden'); m.style.display = 'none'; }
    }
    function setProgress(pct, msg = '') {
      el('#progress-bar').style.width = `${pct}%`;
      el('#progress-num').textContent = Math.max(0, Math.min(100, Math.round(pct)));
      if (msg) el('#progress-msg').textContent = msg;
    }
    function fireConfetti() {
      const duration = 1200;
      const end = Date.now() + duration;
      (function frame() {
        confetti({ particleCount: 7, angle: 60, startVelocity: 50, spread: 55, origin: { x: 0 } });
        confetti({ particleCount: 7, angle: 120, startVelocity: 50, spread: 55, origin: { x: 1 } });
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }
    function toastOK() {
      const t = el('#toast');
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 1800);
    }
    function setDiag(hidden, html = '') {
      el('#diag-content').innerHTML = html || '';
      el('#diag').classList.toggle('hidden', hidden);
    }

    // ===== Arquivo / DOCX =====
    async function fileToArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsArrayBuffer(file);
      });
    }

    async function fetchArrayBuffer(urlBase) {
      const url = urlBase.endsWith('.docx') ? urlBase : `${urlBase}.docx`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Template não encontrado: ' + url);
      return await resp.arrayBuffer();
    }

    function appendImagesToDocument(zip, imagesU8) {
      if (!imagesU8.length) return zip;
      const mediaNames = imagesU8.map((u8, i) => `word/media/compat_img_${Date.now()}_${i}.png`);
      mediaNames.forEach((name, i) => zip.file(name, imagesU8[i]));

      const relsPath = "word/_rels/document.xml.rels";
      let relsXml = zip.file(relsPath).asText();
      const relBase = 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/image';
      const nextId = (() => {
        const ids = [...relsXml.matchAll(/Id="rId(\d+)"/g)].map(m => +m[1]);
        return (ids.length ? Math.max(...ids) : 100) + 1;
      })();
      const rIds = mediaNames.map((_, idx) => `rId${nextId + idx}`);
      const relsToAdd = mediaNames.map((name, idx) =>
        `<Relationship Id="${rIds[idx]}" Type="${relBase}" Target="../media/${name.split('/').pop()}" />`
      ).join('');
      relsXml = relsXml.replace(/<\/Relationships>\s*$/i, `${relsToAdd}</Relationships>`);
      zip.file(relsPath, relsXml);

      const docPath = "word/document.xml";
      let docXml = zip.file(docPath).asText();
      const pageBreak = `<w:p><w:r><w:br w:type="page"/></w:r></w:p>`;
      const drawings = rIds.map(rid => `
      <w:p>
        <w:r>
          <w:drawing>
            <wp:inline distT="0" distB="0" distL="0" distR="0"
                xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
                xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
                xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
              <wp:extent cx="16000000" cy="9000000"/>
              <wp:docPr id="1" name="CompatImage"/>
              <a:graphic>
                <a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">
                  <pic:pic>
                    <pic:nvPicPr><pic:cNvPr id="0" name=""/><pic:cNvPicPr/></pic:nvPicPr>
                    <pic:blipFill>
                      <a:blip r:embed="${rid}" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"/>
                      <a:stretch><a:fillRect/></a:stretch>
                    </pic:blipFill>
                    <pic:spPr>
                      <a:prstGeom prst="rect"><a:avLst/></a:prstGeom>
                    </pic:spPr>
                  </pic:pic>
                </a:graphicData>
              </a:graphic>
            </wp:inline>
          </w:drawing>
        </w:r>
      </w:p>`).join('\n');

      docXml = docXml.replace(/<\/w:document>\s*$/i, `${pageBreak}\n${drawings}\n</w:document>`);
      zip.file(docPath, docXml);
      return zip;
    }

    function normalize_xml(xml) {
      return xml
        .replace(/<w:t[^>]*>\s+/g, '<w:t>')
        .replace(/\s+<\/w:t>/g, '</w:t>')
        .replace(/>\s+</g, '><');
    }

    function replacePlaceholdersInZip(zip, replacements, removeImageKeysRegex) {
      const files = zip.file(/word\/.*\.xml/);
      files.forEach(f => {
        let xml = f.asText();
        xml = normalize_xml(xml);
        Object.entries(replacements).forEach(([k, v]) => {
          const pattern = new RegExp(String.raw`\{\{\s*${k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\s*\}\}`, 'g');
          xml = xml.replace(pattern, v);
        });
        // Remove placeholders de imagem no corpo do documento
        xml = xml.replace(/\{\{\s*([^{}]+?)\s*\}\}/g, (m, key) => removeImageKeysRegex.test(key) ? '' : m);
        zip.file(f.name, xml);
      });
      return zip;
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      const manual = el('#manual-link'); const box = el('#fallback-link');
      manual.href = url; manual.download = filename; box.classList.remove('hidden');
      setTimeout(() => { URL.revokeObjectURL(url); box.classList.add('hidden'); }, 2000);
    }

    // ===== Coleta e preview =====
    function collectDataObject() {
      const data = {};
      els('#accordion [data-key]').forEach((inp) => {
        const key = inp.dataset.key;
        let val = (inp.value || '').toString();
        if (key === 'DATA_EMISSAO_CONTRATO' && !val) {
          val = new Date().toLocaleDateString('pt-BR');
        }
        data[key] = val;
      });

      // Campos personalizados
      const ks = el('#custom-fields').querySelectorAll('[data-type="custom-key"]');
      ks.forEach((kEl, i) => {
        const rawKey = (kEl.value || '').trim().replace(/[{}]/g,'');
        const val = el('#custom-fields').querySelectorAll('[data-type="custom-val"]')[i].value || '';
        if (rawKey) data[rawKey] = val;
      });

      // Garantir que os calculados estão coerentes (caso usuário não tenha interagido)
      const vProdutos = parseBRL(data['VALOR_PRODUTOS_INSTALACAO'] || '');
      const vDesc = parseBRL(data['VALOR_DESCONTO'] || '');
      const total = Math.max(0, (vProdutos || 0) - (vDesc || 0));
      data['VALOR_TOTAL'] = total ? formatBRL(total) : '';
      data['VALOR_TOTAL_POR_EXTENSO'] = total ? numeroPorExtensoBRL(total) : '';

      return data;
    }

    function refreshPreview() {
      const prev = el('#preview'); prev.innerHTML = '';
      const data = collectDataObject();
      Object.keys(data).sort().forEach(k => {
        const v = data[k] || '';
        prev.insertAdjacentHTML('beforeend',
          `<div><code>{{${k}}}</code> → <span class="text-gray-700">${(v || '<i>vazio</i>')}</span></div>`);
      });
    }

    // ===== Fluxo principal =====
    el('#btn-generate').addEventListener('click', async () => {
      if (!currentCompany) { alert('Escolha a empresa primeiro.'); return; }
      const chosen = getActiveDocs();
      if (!chosen.length) { alert('Selecione pelo menos um documento.'); return; }

      showProgress(true); setDiag(true);
      try {
        const data = collectDataObject();

        // Diag
        const diag = `
          <div><b>Chaves (texto) → valor:</b></div>
          <ul class="list-disc pl-5">${Object.keys(data).map(k=>`<li><code>{{${k}}}</code> → ${data[k] || '<i>vazio</i>'}</li>`).join('')}</ul>
          <div class="mt-2 text-xs text-gray-500">Placeholders que combinem <code>/(DESENHO|FOTO)/i</code> serão removidos e as imagens anexadas ao final.</div>
        `;
        setDiag(false, diag);

        // Imagens
        const images = [];
        const files = el('#foto-input').files || [];
        for (const f of files) {
          const ab = await fileToArrayBuffer(f);
          images.push(new Uint8Array(ab));
        }

        for (let i = 0; i < chosen.length; i++) {
          setProgress(Math.round((i / chosen.length) * 100), `Processando ${chosen[i]}…`);
          await generateOneDocx(currentCompany, chosen[i], data, images);
        }

        fireConfetti();
        toastOK();
      } catch (e) {
        console.error(e);
        alert('Falha na geração: ' + (e.message || e));
      } finally {
        setTimeout(() => showProgress(false), 1200);
      }
    });

    async function generateOneDocx(company, docName, data, images) {
      setProgress(5, 'Baixando template…');
      const url = `templates/${company}/${docName}.docx`;
      const ab = await fetchArrayBuffer(url);

      setProgress(25, 'Abrindo arquivo…');
      let zip = new PizZip(ab);

      setProgress(55, 'Substituindo placeholders…');
      zip = replacePlaceholdersInZip(zip, data, IMAGE_KEY_HINT);

      setProgress(75, 'Anexando imagens (final)…');
      if (images && images.length) zip = appendImagesToDocument(zip, images);

      setProgress(90, 'Compactando DOCX…');
      const out = zip.generate({ type: 'blob' });

      setProgress(100, 'Concluído!');
      downloadBlob(out, `${company}_${docName}.docx`);
    }

    // Inicialização
    (function init() {
      els('.company-card').forEach(b=>b.addEventListener('click', ()=> {
        el('#step-config').classList.remove('hidden');
      }));
    })();
  </script>
</body>
</html>
