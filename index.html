<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de Contratos — PDF (templates DOCX com {{CHAVE}})</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PizZip para abrir/zipar DOCX -->
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.7/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.7/dist/pizzip-utils.min.js"></script>

  <!-- JSZip (OBRIGATÓRIO para docx-preview) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- docx-preview (renderiza DOCX -> HTML no browser) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docx-preview@0.3.1/dist/docx-preview.css">
  <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.3.1/dist/docx-preview.min.js"></script>

  <!-- html2pdf (HTML -> PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <!-- Lucide Icons (UMD) -->
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <style>
    .progress-striped{
      background-image:linear-gradient(45deg,rgba(255,255,255,.25) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.25) 50%,rgba(255,255,255,.25) 75%,transparent 75%,transparent);
      background-size:1rem 1rem;animation:progress 1s linear infinite
    }
    @keyframes progress{from{background-position:1rem 0}to{background-position:0 0}}
    .card-hover{transition:transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease}
    .card-hover:hover{transform:translateY(-1px) scale(1.01);box-shadow:0 10px 24px rgba(0,0,0,.1);border-color:rgb(30 41 59 / .2)}
    .selected-card{transform:translateY(-2px) scale(1.012);box-shadow:0 22px 44px -14px rgba(0,0,0,.28), 0 6px 14px rgba(0,0,0,.06);border-color:rgb(15 23 42 / .35)}
    .acc-item{border-radius:1rem;border:1px solid rgb(226 232 240);overflow:hidden}
    .acc-header{width:100%;text-align:left;padding:.875rem 1rem;display:flex;align-items:center;justify-content:space-between}
    .acc-body{padding:.75rem 1rem 1rem;border-top:1px dashed rgb(226 232 240)}
    #pdf-stage{width:794px;background:#fff;padding:24px}
    #pdf-stage.hidden{display:none}
  </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased min-h-screen">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold">Gerador de Contratos (PDF)</h1>
      <div class="text-sm text-gray-500">Templates DOCX com {{CHAVE}}</div>
    </header>

    <!-- Seleção de empresa -->
    <section id="company-grid" class="grid md:grid-cols-2 gap-4">
      <button type="button" data-company="InovaInox" class="company-card card-hover rounded-2xl bg-white shadow border p-6 text-left w-full">
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 text-gray-700">
            <i data-lucide="building-2" class="w-6 h-6"></i>
            <i data-lucide="drill" class="w-6 h-6"></i>
          </div>
          <div>
            <div class="font-semibold text-lg leading-tight">Inova Inox</div>
            <div class="text-gray-500 text-sm leading-tight">Contrato, OS e Capa</div>
          </div>
        </div>
      </button>

      <button type="button" data-company="PortoStone" class="company-card card-hover rounded-2xl bg-white shadow border p-6 text-left w-full">
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 text-gray-700">
            <i data-lucide="building-2" class="w-6 h-6"></i>
            <i data-lucide="hammer" class="w-6 h-6"></i>
          </div>
          <div>
            <div class="font-semibold text-lg leading-tight">Porto Stone</div>
            <div class="text-gray-500 text-sm leading-tight">Contrato e OS</div>
          </div>
        </div>
      </button>
    </section>

    <!-- Passo de configuração -->
    <section id="step-config" class="hidden mt-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <button id="btn-back" type="button" class="text-sm px-3 py-1.5 rounded-lg border">← Voltar</button>
          <h2 class="text-xl font-semibold"><span id="label-company"></span></h2>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-4">
        <div class="rounded-2xl bg-white shadow border p-5">
          <div class="font-medium mb-3">Documentos</div>
          <div id="doc-options" class="space-y-2 text-sm"></div>
          <p class="text-xs text-gray-500 mt-3">
            Placeholders de texto: <b>{{CHAVE}}</b>.<br>
            Placeholders de imagens (ex.: <code>{{DESENHO1}}</code>, <code>{{FOTO_ORÇAMENTO}}</code>) são removidos do corpo e imagens anexadas ao final.
          </p>
        </div>

        <div class="rounded-2xl bg-white shadow border p-5 lg:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <div class="font-medium">Campos</div>
            <input id="filter-input" placeholder="Filtrar campo/CHAVE..." class="rounded-xl border px-3 py-2 text-sm w-60">
          </div>

          <div id="accordion" class="space-y-3"></div>

          <div class="mt-5">
            <div class="font-medium mb-1">Imagens (opcional)</div>
            <input id="foto-input" type="file" accept="image/*" multiple class="block w-full text-sm border rounded-xl px-3 py-2" />
            <p class="text-xs text-gray-500 mt-1">Serão inseridas numa nova página ao final.</p>
          </div>

          <div class="mt-5">
            <div class="flex items-center justify-between">
              <div class="font-medium">Campos personalizados</div>
              <button id="add-custom" type="button" class="text-sm px-3 py-1.5 rounded-lg border">+ Adicionar</button>
            </div>
            <div id="custom-fields" class="mt-2 space-y-2"></div>
          </div>

          <div class="flex items-center justify-end gap-3 mt-6">
            <button id="btn-generate" type="button" class="px-5 py-2.5 rounded-xl bg-black text-white">Gerar PDF</button>
          </div>
        </div>
      </div>

      <div class="mt-6 rounded-2xl bg-white shadow border p-5">
        <div class="font-medium">Prévia de substituições</div>
        <div id="preview" class="mt-2 text-sm grid md:grid-cols-2 gap-x-6 gap-y-1"></div>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-400 mt-10">
      Templates DOCX com {{CHAVE}} → exporta PDF no navegador.
    </footer>
  </div>

  <!-- Modal de progresso -->
  <div id="progress-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
      <div class="flex items-center gap-3 mb-3">
        <div class="h-10 w-10 rounded-full bg-black text-white grid place-items-center font-semibold">%</div>
        <div>
          <h3 class="text-lg font-semibold">Gerando documento…</h3>
          <p id="progress-msg" class="text-xs text-gray-500">Preparando…</p>
        </div>
      </div>
      <div class="w-full h-3 rounded-full bg-gray-200 overflow-hidden">
        <div id="progress-bar" class="h-full w-0 bg-black progress-striped"></div>
      </div>
      <div class="text-right text-sm mt-2"><span id="progress-num">0</span>%</div>
      <div id="diag" class="mt-4 hidden">
        <details class="text-xs text-gray-600">
          <summary class="cursor-pointer font-medium">Diagnóstico</summary>
          <div class="mt-2 space-y-2" id="diag-content"></div>
        </details>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 top-6 hidden z-[60]">
    <div class="px-4 py-2 bg-white shadow-lg rounded-xl border flex items-center gap-2">
      <span>✅ PDF gerado!</span>
    </div>
  </div>

  <div id="pdf-stage" class="hidden"></div>

  <script>
    // ===== Helpers =====
    const el  = (s) => document.querySelector(s);
    const els = (s) => Array.from(document.querySelectorAll(s));

    function hydrateIcons() {
      if (window.lucide && typeof window.lucide.createIcons === 'function') {
        window.lucide.createIcons();
      }
    }

    // BRL
    const fmtBRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const formatBRL = (n) => fmtBRL.format(isFinite(n) ? n : 0);
    const parseBRL = (s) => {
      if (typeof s !== 'string') return Number(s) || 0;
      const clean = s.replace(/\s/g,'').replace(/\./g,'').replace(',', '.').replace(/[^\d.-]/g,'');
      const n = parseFloat(clean);
      return isNaN(n) ? 0 : n;
    };

    function numeroPorExtensoBRL(valor) {
      const unidades = ['','um','dois','três','quatro','cinco','seis','sete','oito','nove'];
      const onzeDezenove = ['onze','doze','treze','quatorze','quinze','dezesseis','dezessete','dezoito','dezenove'];
      const dezenas = ['','dez','vinte','trinta','quarenta','cinquenta','sessenta','setenta','oitenta','noventa'];
      const centenas = ['','cento','duzentos','trezentos','quatrocentos','quinhentos','seiscentos','setecentos','oitocentos','novecentos'];
      const classes = [
        {sing:'', plur:''},
        {sing:'mil', plur:'mil'},
        {sing:'milhão', plur:'milhões'},
        {sing:'bilhão', plur:'bilhões'},
        {sing:'trilhão', plur:'trilhões'},
      ];
      const inteiro = Math.floor(Math.abs(valor));
      const cent = Math.round((Math.abs(valor) - inteiro) * 100);
      const tres = (n) => {
        if (n === 0) return '';
        if (n === 100) return 'cem';
        let c = Math.floor(n/100), d = Math.floor((n%100)/10), u = n%10;
        let out = [];
        if (c) out.push(centenas[c]);
        if (d === 1 && u > 0) out.push(onzeDezenove[u-1]);
        else {
          if (d) out.push(dezenas[d]);
          if (u) out.push(unidades[u]);
        }
        return out.join(' e ');
      };
      const toGroups = (n) => {
        const s = n.toString().padStart(Math.ceil(n.toString().length/3)*3, '0');
        const arr = [];
        for (let i=0;i<s.length;i+=3) arr.push(Number(s.slice(i,i+3)));
        return arr;
      };
      const grupos = toGroups(inteiro);
      let partes = [];
      grupos.forEach((g, idx) => {
        const pos = grupos.length - 1 - idx;
        const t = tres(g);
        if (!t) return;
        const nome = classes[pos] || classes[classes.length-1];
        if (pos === 0) partes.push(t);
        else if (g === 1) partes.push(t + (nome.sing ? ' ' + nome.sing : ''));
        else partes.push(t + ' ' + nome.plur);
      });
      let reais = partes.join(', ').replace(/, ([^,]*)$/, ' e $1');
      if (!reais) reais = 'zero';
      reais += (inteiro === 1 ? ' real' : ' reais');
      let centavos = '';
      if (cent > 0) {
        const t = tres(cent);
        centavos = (t || 'zero') + (cent === 1 ? ' centavo' : ' centavos');
      }
      return centavos ? (reais + ' e ' + centavos) : reais;
    }

    // ===== Dados do app =====
    const DOCS = {
      InovaInox: ['Contrato', 'Ordem_de_Servico', 'Capa'],
      PortoStone: ['Contrato', 'Ordem_de_Servico'],
    };
    const COMMON_FIELDS = [
      { key: 'NOME_CONTRATANTE', label: 'Nome do cliente' },
      { key: 'CPF_CONTRATANTE', label: 'CPF/CNPJ' },
      { key: 'TELEFONE_CONTRATANTE', label: 'Telefone' },
      { key: 'ENDERECO_CONTRATANTE', label: 'Endereço' },
      { key: 'TIPO_DE_PROJETO', label: 'Tipo de projeto' },
      { key: 'DATA_EMISSAO_CONTRATO', label: 'Data de emissão (auto)', placeholder: 'auto' },
    ];
    const FIELDS_BY_DOC = {
      InovaInox: {
        Contrato: [ { key: 'NÚMERO_PARCELAS', label: 'Número de parcelas' } ],
        Ordem_de_Servico: [
          { key: 'ORDEM_PRODUCAO', label: 'Ordem de Produção' },
          { key: 'CIDADE', label: 'Cidade' },
          { key: 'VENDEDOR', label: 'Vendedor' },
        ],
        Capa: [
          { key: 'ORDEM_PRODUCAO', label: 'Ordem de Produção' },
          { key: 'ENDERECO_CONTRATANTE_PROJETO', label: 'Endereço do projeto (obra)' },
        ],
      },
      PortoStone: { Contrato: [], Ordem_de_Servico: [{ key: 'ORDEM_PRODUCAO', label: 'Ordem de Produção' }] },
    };
    const FIN_KEYS = {
      VALOR_PRODUTOS_INSTALACAO: { label: 'Valor Instalação e Produtos', type: 'money' },
      VALOR_DESCONTO: { label: 'Desconto', type: 'money' },
      VALOR_TOTAL: { label: 'Valor Total (auto)', type: 'money-readonly' },
      VALOR_TOTAL_POR_EXTENSO: { label: 'Valor Total por extenso (auto)', type: 'textarea-readonly' },
      VALOR_ENTRADA: { label: 'Valor Entrada', type: 'money' },
      METODO_PAGAMENTO_ENTRADA: { label: 'Método Pagamento Entrada', type: 'select', options: ['PIX','Cartão','Dinheiro','Boleto','Transferência'] },
      NÚMERO_PARCELAS: { label: 'Número de Parcelas', type: 'number' },
      VALOR_PARCELAS: { label: 'Valor das parcelas (auto)', type: 'money-readonly' },
    };
    const IMAGE_KEY_HINT = /(DESENHO|FOTO)/i;

    let currentCompany = null;

    function selectCompanyCard(btn) {
      els('.company-card').forEach(b => b.classList.remove('selected-card'));
      btn.classList.add('selected-card');
    }

    function renderDocOptions() {
      const wrap = el('#doc-options'); wrap.innerHTML = '';
      (DOCS[currentCompany] || []).forEach((name) => {
        const isChecked = name === 'Contrato' ? 'checked' : '';
        wrap.insertAdjacentHTML('beforeend', `
          <label class="flex items-center gap-2">
            <input type="checkbox" class="accent-black doc-check" id="doc-${name}" ${isChecked} />
            <span>${name.replace(/_/g,' ')}</span>
          </label>`);
      });
      els('.doc-check').forEach((c) => c.addEventListener('change', () => {
        renderAccordion();
      }));
      hydrateIcons();
    }

    function getActiveDocs() { return (DOCS[currentCompany] || []).filter((name) => el('#doc-' + name)?.checked); }

    function getAllFieldsGrouped() {
      const active = getActiveDocs();
      const groups = {
        identificacao: { title: 'Identificação do cliente', fields: [] },
        endereco: { title: 'Endereço', fields: [] },
        projeto: { title: 'Projeto', fields: [] },
        financeiro: { title: 'Financeiro', fields: [] },
        comercial: { title: 'Comercial / Operacional (OS)', fields: [] },
      };
      COMMON_FIELDS.forEach(f => {
        if (['NOME_CONTRATANTE','CPF_CONTRATANTE','TELEFONE_CONTRATANTE'].includes(f.key)) groups.identificacao.fields.push(f);
        else if (['ENDERECO_CONTRATANTE'].includes(f.key)) groups.endereco.fields.push(f);
        else if (['TIPO_DE_PROJETO','DATA_EMISSAO_CONTRATO'].includes(f.key)) groups.projeto.fields.push(f);
      });
      active.forEach(doc => {
        (FIELDS_BY_DOC[currentCompany]?.[doc] || []).forEach(f => {
          if (doc === 'Capa' && f.key === 'ENDERECO_CONTRATANTE_PROJETO') groups.endereco.fields.push(f);
          else if (['ORDEM_PRODUCAO'].includes(f.key) || f.key === 'ENDERECO_CONTRATANTE_PROJETO') groups.projeto.fields.push(f);
          else if (doc === 'Ordem_de_Servico') groups.comercial.fields.push(f);
        });
      });
      if (active.includes('Contrato')) {
        groups.financeiro.fields = [
          { key: 'VALOR_PRODUTOS_INSTALACAO', ...FIN_KEYS.VALOR_PRODUTOS_INSTALACAO },
          { key: 'VALOR_DESCONTO', ...FIN_KEYS.VALOR_DESCONTO },
          { key: 'VALOR_TOTAL', ...FIN_KEYS.VALOR_TOTAL },
          { key: 'VALOR_TOTAL_POR_EXTENSO', ...FIN_KEYS.VALOR_TOTAL_POR_EXTENSO },
          { key: 'VALOR_ENTRADA', ...FIN_KEYS.VALOR_ENTRADA },
          { key: 'METODO_PAGAMENTO_ENTRADA', ...FIN_KEYS.METODO_PAGAMENTO_ENTRADA },
          { key: 'NÚMERO_PARCELAS', ...FIN_KEYS.NÚMERO_PARCELAS },
          { key: 'VALOR_PARCELAS', ...FIN_KEYS.VALOR_PARCELAS },
        ];
      }
      for (const g of Object.values(groups)) {
        const seen = new Set();
        g.fields = g.fields.filter(f => !seen.has(f.key) && seen.add(f.key));
      }
      return groups;
    }

    function fieldInput({ key, label, type='text', placeholder='', options=[] }) {
      const id = 'f-' + key;
      const baseLabel = `<label for="${id}" class="text-sm font-medium">${label} <span class="text-gray-400 text-xs">(${key})</span></label>`;
      if (type === 'textarea' || type === 'textarea-readonly') {
        return `<div class="flex flex-col gap-1">${baseLabel}
          <textarea id="${id}" data-key="${key}" rows="2" class="mt-1 w-full rounded-xl border px-3 py-2 ${type==='textarea-readonly'?'bg-gray-50 text-gray-700':''}" ${type==='textarea-readonly'?'readonly':''}></textarea>
        </div>`;
      }
      if (type === 'select') {
        return `<div class="flex flex-col gap-1">${baseLabel}
          <select id="${id}" data-key="${key}" class="mt-1 w-full rounded-xl border px-3 py-2">
            <option value="">Selecione…</option>${options.map(o=>`<option value="${o}">${o}</option>`).join('')}
          </select>
        </div>`;
      }
      if (type === 'number') {
        return `<div class="flex flex-col gap-1">${baseLabel}
          <input id="${id}" data-key="${key}" type="number" min="0" step="1" class="mt-1 w-full rounded-xl border px-3 py-2" />
        </div>`;
      }
      if (type === 'money' || type === 'money-readonly') {
        return `<div class="flex flex-col gap-1">${baseLabel}
          <input id="${id}" data-key="${key}" inputmode="decimal" class="mt-1 w-full rounded-xl border px-3 py-2 ${type==='money-readonly'?'bg-gray-50 text-gray-700':''}" ${type==='money-readonly'?'readonly':''} />
        </div>`;
      }
      return `<div class="flex flex-col gap-1">${baseLabel}
        <input id="${id}" data-key="${key}" placeholder="${placeholder}" class="mt-1 w-full rounded-xl border px-3 py-2" />
      </div>`;
    }

    function renderFinanceCustom(fields) {
      const input = (key) => fieldInput(fields.find(f=>f.key===key));
      const totalRow = `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">${input('VALOR_TOTAL')}${input('VALOR_TOTAL_POR_EXTENSO')}</div>`;
      const entradaRow = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
          <div class="flex items-center gap-3">
            <input id="chk-VALOR_ENTRADA" type="checkbox" class="w-4 h-4 accent-black" />
            <div class="flex-1">${input('VALOR_ENTRADA').replace('input id="f-VALOR_ENTRADA"', 'input id="f-VALOR_ENTRADA" disabled')}</div>
          </div>
          <div id="wrap-METODO_PAGAMENTO_ENTRADA" class="hidden">${input('METODO_PAGAMENTO_ENTRADA')}</div>
        </div>`;
      const parcelasRow = `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">${input('NÚMERO_PARCELAS')}${input('VALOR_PARCELAS')}</div>`;
      return `<div class="space-y-3">
        ${input('VALOR_PRODUTOS_INSTALACAO')}
        ${input('VALOR_DESCONTO')}
        ${totalRow}
        ${entradaRow}
        ${parcelasRow}
      </div>`;
    }

    function renderAccordion() {
      const wrap = el('#accordion'); wrap.innerHTML = '';
      const groups = getAllFieldsGrouped();
      const order = ['identificacao','endereco','projeto','financeiro','comercial'];
      order.forEach((gk, idx) => {
        const g = groups[gk];
        if (!g.fields.length) return;
        const bodyId = `acc-body-${gk}`;
        const count = g.fields.length;
        wrap.insertAdjacentHTML('beforeend', `
          <div class="acc-item">
            <button type="button" class="acc-header" data-target="${bodyId}">
              <span class="font-medium">${g.title} <span class="text-xs text-gray-500">(${count})</span></span>
              <i data-lucide="chevron-down" class="w-5 h-5"></i>
            </button>
            <div id="${bodyId}" class="acc-body ${idx ? 'hidden' : ''}">
              ${gk === 'financeiro'
                ? renderFinanceCustom(g.fields)
                : `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">${g.fields.map(f => fieldInput(f)).join('')}</div>`
              }
            </div>
          </div>`);
      });
      els('.acc-header').forEach(h => h.addEventListener('click', () => {
        const id = h.dataset.target; el('#'+id).classList.toggle('hidden');
      }));
      bindFinanceHandlers();
      bindGenericHandlers();
      updateCalculatedFields();
      refreshPreview();
      hydrateIcons();
      installFilter();
    }

    function bindGenericHandlers() {
      const date = el('#f-DATA_EMISSAO_CONTRATO');
      if (date && !date.value) date.value = new Date().toLocaleDateString('pt-BR');
      els('[data-key]').forEach(inp => {
        inp.addEventListener('input', refreshPreview);
        inp.addEventListener('blur', refreshPreview);
      });
    }

    function bindFinanceHandlers() {
      ['VALOR_PRODUTOS_INSTALACAO','VALOR_DESCONTO','VALOR_ENTRADA'].forEach(k => {
        const inp = el('#f-' + k); if (!inp) return;
        inp.addEventListener('input', () => { updateCalculatedFields(); refreshPreview(); });
        inp.addEventListener('blur', () => { const n = parseBRL(inp.value); inp.value = n ? formatBRL(n) : ''; updateCalculatedFields(); refreshPreview(); });
      });
      const chk = el('#chk-VALOR_ENTRADA');
      const inpEnt = el('#f-VALOR_ENTRADA');
      const wrapMetodo = el('#wrap-METODO_PAGAMENTO_ENTRADA');
      if (chk) chk.addEventListener('change', () => {
        const on = chk.checked;
        if (inpEnt) { inpEnt.disabled = !on; if (!on) inpEnt.value = ''; }
        if (wrapMetodo) wrapMetodo.classList.toggle('hidden', !on);
        updateCalculatedFields(); refreshPreview();
      });
      const npar = el('#f-NÚMERO_PARCELAS');
      if (npar) {
        npar.addEventListener('input', () => { updateCalculatedFields(); refreshPreview(); });
        npar.addEventListener('blur', () => { updateCalculatedFields(); refreshPreview(); });
      }
    }

    function updateCalculatedFields() {
      const vProdutos = parseBRL(el('#f-VALOR_PRODUTOS_INSTALACAO')?.value || '');
      const vDesc = parseBRL(el('#f-VALOR_DESCONTO')?.value || '');
      const total = Math.max(0, (vProdutos || 0) - (vDesc || 0));
      const totalEl = el('#f-VALOR_TOTAL'); if (totalEl) totalEl.value = total ? formatBRL(total) : '';
      const extensoEl = el('#f-VALOR_TOTAL_POR_EXTENSO'); if (extensoEl) extensoEl.value = total ? numeroPorExtensoBRL(total) : '';
      const entradaOn = !!el('#chk-VALOR_ENTRADA')?.checked;
      const vEntrada = entradaOn ? parseBRL(el('#f-VALOR_ENTRADA')?.value || '') : 0;
      const nParcelas = parseInt(el('#f-NÚMERO_PARCELAS')?.value || '0', 10);
      const base = Math.max(0, total - (vEntrada || 0));
      const vParcela = (nParcelas > 0) ? (base / nParcelas) : 0;
      const parcelasEl = el('#f-VALOR_PARCELAS');
      if (parcelasEl) parcelasEl.value = (nParcelas > 0 && base >= 0) ? formatBRL(vParcela) : '';
    }

    function installFilter() {
      const fi = el('#filter-input'); if (!fi || fi._bound) return;
      fi._bound = true;
      fi.addEventListener('input', () => {
        const q = (fi.value || '').trim().toLowerCase();
        els('[data-key]').forEach(n => {
          const key = n.dataset.key?.toLowerCase?.() || '';
          const label = (n.closest('div')?.querySelector('label')?.textContent || '').toLowerCase();
          const show = !q || key.includes(q) || label.includes(q);
          n.closest('.flex.flex-col')?.classList.toggle('hidden', !show);
        });
      });
    }

    async function fileToArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsArrayBuffer(file);
      });
    }

    async function fetchArrayBuffer(urlBase) {
      const url = urlBase.endsWith('.docx') ? urlBase : `${urlBase}.docx`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Template não encontrado: ' + url);
      return await resp.arrayBuffer();
    }

    // Escapa valores para XML (evita quebrar <w:t>, txbxContent, etc.)
    function xmlEscape(s='') {
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&apos;');
    }

    function appendImagesToDocument(zip, imagesU8) {
      if (!imagesU8.length) return zip;
      const mediaNames = imagesU8.map((u8, i) => `word/media/compat_img_${Date.now()}_${i}.png`);
      mediaNames.forEach((name, i) => zip.file(name, imagesU8[i]));
      const relsPath = "word/_rels/document.xml.rels";
      let relsXml = zip.file(relsPath).asText();
      const relBase = 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/image';
      const nextId = (() => {
        const ids = [...relsXml.matchAll(/Id="rId(\d+)"/g)].map(m => +m[1]);
        return (ids.length ? Math.max(...ids) : 100) + 1;
      })();
      const rIds = mediaNames.map((_, idx) => `rId${nextId + idx}`);
      const relsToAdd = mediaNames.map((name, idx) =>
        `<Relationship Id="${rIds[idx]}" Type="${relBase}" Target="../media/${name.split('/').pop()}" />`
      ).join('');
      relsXml = relsXml.replace(/<\/Relationships>\s*$/i, `${relsToAdd}</Relationships>`);
      zip.file(relsPath, relsXml);
      const docPath = "word/document.xml";
      let docXml = zip.file(docPath).asText();
      const pageBreak = `<w:p><w:r><w:br w:type="page"/></w:r></w:p>`;
      const drawings = rIds.map(rid => `
      <w:p>
        <w:r>
          <w:drawing>
            <wp:inline distT="0" distB="0" distL="0" distR="0"
                xmlns:wp="http://schemas.openxmlformats.org/wordprocessingDrawing"
                xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
                xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
              <wp:extent cx="16000000" cy="9000000"/>
              <wp:docPr id="1" name="CompatImage"/>
              <a:graphic>
                <a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">
                  <pic:pic>
                    <pic:nvPicPr><pic:cNvPr id="0" name=""/><pic:cNvPicPr/></pic:nvPicPr>
                    <pic:blipFill>
                      <a:blip r:embed="${rid}" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"/>
                      <a:stretch><a:fillRect/></a:stretch>
                    </pic:blipFill>
                    <pic:spPr>
                      <a:prstGeom prst="rect"><a:avLst/></a:prstGeom>
                    </pic:spPr>
                  </pic:pic>
                </a:graphicData>
              </a:graphic>
            </wp:inline>
          </w:drawing>
        </w:r>
      </w:p>`).join('\n');
      docXml = docXml.replace(/<\/w:document>\s*$/i, `${pageBreak}\n${drawings}\n</w:document>`);
      zip.file(docPath, docXml);
      return zip;
    }

    // Não colapsa agressivamente o XML (evita mexer em txbxContent/v: shapes)
    function normalize_xml(xml) {
      return xml
        .replace(/<w:t([^>]*)>\s+/g, '<w:t$1>')   // espaços à esquerda dentro de w:t
        .replace(/\s+<\/w:t>/g, '</w:t>');        // espaços à direita dentro de w:t
    }

    function replacePlaceholdersInZip(zip, replacements, removeImageKeysRegex) {
      const files = zip.file(/word\/.*\.xml/); // document, headers, footers, etc.
      files.forEach(f => {
        let xml = f.asText();
        xml = normalize_xml(xml);

        // 1) Remove chaves de imagem (em qualquer lugar) — sem quebrar XML
        xml = xml.replace(/\{\{\s*([^{}]+?)\s*\}\}/g, (m, key) => removeImageKeysRegex.test(key) ? '' : m);

        // 2) Substitui chaves de texto com ESCAPE de XML
        for (const [rawK, rawV] of Object.entries(replacements)) {
          const k = rawK.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
          const v = xmlEscape(rawV ?? '');
          const pattern = new RegExp(String.raw`\{\{\s*${k}\s*\}\}`, 'g');
          xml = xml.replace(pattern, v);
        }

        zip.file(f.name, xml);
      });
      return zip;
    }

    async function docxBlobToPdf(blob, filenamePdf) {
      const stage = document.getElementById('pdf-stage');
      if (!stage) throw new Error('#pdf-stage não encontrado');
      if (!window.docx || typeof window.docx.renderAsync !== 'function') {
        alert("docx-preview não carregado corretamente. PDF não pôde ser gerado.");
        throw new Error("docx-preview não carregado");
      }
      if (!window.html2pdf || typeof window.html2pdf !== 'function') {
        alert("html2pdf não carregado. PDF não pôde ser gerado.");
        throw new Error("html2pdf não carregado");
      }
      stage.innerHTML = '';
      stage.classList.remove('hidden');
      await window.docx.renderAsync(blob, stage, null, {
        ignoreWidth:false, ignoreHeight:false, className:'docx', inWrapper:true
      });
      if (!stage.innerHTML || stage.innerHTML.trim() === '') {
        alert('Falha ao renderizar o template DOCX. PDF não será gerado!');
        throw new Error("Falha ao renderizar DOCX em HTML");
      }
      const opt = {
        margin:[10,10,10,10],
        filename: filenamePdf,
        image:{ type:'jpeg', quality:0.98 },
        html2canvas:{ scale:2, useCORS:true },
        jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }
      };
      await html2pdf().set(opt).from(stage).save();
      stage.classList.add('hidden');
    }

    function collectDataObject() {
      const data = {};
      els('[data-key]').forEach((inp) => {
        const key = inp.dataset.key;
        let val = (inp.value || '').toString();
        if (key === 'DATA_EMISSAO_CONTRATO' && !val) val = new Date().toLocaleDateString('pt-BR');
        if (key === 'VALOR_ENTRADA') {
          const on = !!el('#chk-VALOR_ENTRADA')?.checked;
          val = on ? val : '';
        }
        if (key === 'METODO_PAGAMENTO_ENTRADA') {
          const on = !!el('#chk-VALOR_ENTRADA')?.checked;
          val = on ? val : '';
        }
        data[key] = val;
      });
      // Calculados
      const vProdutos = parseBRL(data['VALOR_PRODUTOS_INSTALACAO'] || '');
      const vDesc = parseBRL(data['VALOR_DESCONTO'] || '');
      const total = Math.max(0, (vProdutos || 0) - (vDesc || 0));
      data['VALOR_TOTAL'] = total ? formatBRL(total) : '';
      data['VALOR_TOTAL_POR_EXTENSO'] = total ? numeroPorExtensoBRL(total) : '';
      const entradaOn = !!el('#chk-VALOR_ENTRADA')?.checked;
      const vEntrada = entradaOn ? parseBRL(data['VALOR_ENTRADA'] || '') : 0;
      const nParcelas = parseInt(data['NÚMERO_PARCELAS'] || '0', 10);
      const base = Math.max(0, total - (vEntrada || 0));
      data['VALOR_PARCELAS'] = (nParcelas > 0 && base >= 0) ? formatBRL(base / nParcelas) : '';

      // Personalizados
      const ks = el('#custom-fields')?.querySelectorAll('[data-type="custom-key"]') || [];
      const vs = el('#custom-fields')?.querySelectorAll('[data-type="custom-val"]') || [];
      ks.forEach((kEl, i) => {
        const rawKey = (kEl.value || '').trim().replace(/[{}]/g,'');
        const val = vs[i]?.value || '';
        if (rawKey) data[rawKey] = val;
      });
      return data;
    }

    function refreshPreview() {
      const prev = el('#preview'); if (!prev) return;
      prev.innerHTML = '';
      const data = collectDataObject();
      Object.keys(data).sort().forEach(k => {
        const v = data[k] || '';
        prev.insertAdjacentHTML('beforeend', `<div><code>{{${k}}}</code> → <span class="text-gray-700">${v || '<i>vazio</i>'}</span></div>`);
      });
    }

    function showProgress(show) {
      const m = document.getElementById('progress-modal');
      if (show) { m.classList.remove('hidden'); m.style.display = 'flex'; setProgress(0, 'Preparando…'); }
      else { m.classList.add('hidden'); m.style.display = 'none'; }
    }
    function setProgress(pct, msg) {
      const bar = document.getElementById('progress-bar');
      const num = document.getElementById('progress-num');
      const txt = document.getElementById('progress-msg');
      const p = Math.max(0, Math.min(100, pct|0));
      if (bar) bar.style.width = p + '%';
      if (num) num.textContent = p;
      if (txt && msg) txt.textContent = msg;
    }
    function setDiag(show) {
      const d = document.getElementById('diag'); if (!d) return;
      d.classList.toggle('hidden', !show);
    }

    async function generateOnePdf(company, docName, data, images) {
      setProgress(5, 'Baixando template…');
      const url = `templates/${company}/${docName}.docx`;
      const ab = await fetchArrayBuffer(url);

      setProgress(25, 'Abrindo arquivo…');
      if (!window.PizZip) throw new Error('PizZip não carregado');
      let zip = new PizZip(ab);

      setProgress(55, 'Substituindo placeholders…');
      zip = replacePlaceholdersInZip(zip, data, IMAGE_KEY_HINT);

      setProgress(75, 'Anexando imagens (final)…');
      if (images && images.length) zip = appendImagesToDocument(zip, images);

      setProgress(90, 'Gerando PDF…');
      const docxBlob = zip.generate({ type: 'blob' }); // DOCX em memória

      try {
        await docxBlobToPdf(docxBlob, `${company}_${docName}.pdf`);
      } catch (err) {
        console.error('Falha na conversão para PDF', err);
        alert('Falha ao gerar PDF. Verifique o template, os campos ou tente novamente.');
        throw err;
      }
      setProgress(100, 'Concluído!');
    }

    // ===== Inicialização =====
    document.addEventListener('DOMContentLoaded', () => {
      // Espera Lucide e hidrata SVGs
      (function waitLucide(){
        if (window.lucide && window.lucide.createIcons) hydrateIcons();
        else setTimeout(waitLucide, 50);
      })();

      // Seleção de empresa
      document.addEventListener('click', (ev) => {
        const btn = ev.target.closest('.company-card');
        if (!btn) return;
        const company = btn.dataset.company;
        if (!company) return;

        currentCompany = company;
        selectCompanyCard(btn);
        el('#label-company').textContent = currentCompany === 'InovaInox' ? 'Inova Inox' : 'Porto Stone';
        el('#step-config').classList.remove('hidden');

        renderDocOptions();
        renderAccordion();
        hydrateIcons();
      });

      // Voltar
      el('#btn-back')?.addEventListener('click', () => location.reload());

      // Add custom field
      el('#add-custom')?.addEventListener('click', () => {
        const box = document.createElement('div');
        box.className = 'grid grid-cols-1 md:grid-cols-2 gap-2';
        box.innerHTML = `
          <input data-type="custom-key" placeholder="CHAVE_PERSONALIZADA (sem {{ }})" class="rounded-xl border px-3 py-2 text-sm" />
          <input data-type="custom-val" placeholder="Valor" class="rounded-xl border px-3 py-2 text-sm" />
        `;
        el('#custom-fields').appendChild(box);
      });

      // Gerar PDF
      el('#btn-generate')?.addEventListener('click', async () => {
        if (!currentCompany) { alert('Escolha a empresa primeiro.'); return; }
        const chosen = (DOCS[currentCompany] || []).filter((name) => el('#doc-' + name)?.checked);
        if (!chosen.length) { alert('Selecione pelo menos um documento.'); return; }

        showProgress(true); setDiag(true);

        try {
          const data = collectDataObject();

          // Diagnóstico
          const list = Object.keys(data).map(k => `<li><code>{{${k}}}</code> → ${data[k] || '<i>vazio</i>'}</li>`).join('');
          el('#diag-content').innerHTML = `
            <div><b>Chaves (texto) → valor:</b></div>
            <ul class="list-disc pl-5">${list}</ul>
            <div class="mt-2 text-xs text-gray-500">Placeholders que combinem <code>/(DESENHO|FOTO)/i</code> serão removidos e as imagens anexadas ao final.</div>
          `;
          el('#diag').classList.remove('hidden');

          // Imagens
          const images = [];
          const files = el('#foto-input')?.files || [];
          for (const f of files) {
            const ab = await fileToArrayBuffer(f);
            images.push(new Uint8Array(ab));
          }

          // Gera cada documento
          for (let i = 0; i < chosen.length; i++) {
            setProgress(Math.round((i / chosen.length) * 100), `Processando ${chosen[i]}…`);
            await generateOnePdf(currentCompany, chosen[i], data, images);
          }

          confetti({ particleCount: 120, spread: 60, origin: { y: 0.7 }});
          const t = el('#toast'); t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1800);
        } catch (e) {
          console.error(e);
          alert('Falha na geração: ' + (e.message || e));
        } finally {
          setTimeout(() => { el('#progress-modal').classList.add('hidden'); el('#progress-modal').style.display='none'; }, 1200);
        }
      });
    });
  </script>
</body>
</html>
