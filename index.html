<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de Contratos — PDF (Busca literal {{CHAVE}})</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { inox: '#0f172a', marble: '#d4af37' },
          boxShadow: { card: '0 8px 30px rgba(0,0,0,0.06)' },
          borderRadius: { '2xl': '1.25rem' }
        }
      }
    }
  </script>

  <!-- pdf-lib -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- pako (inflate/deflate) para lidar com FlateDecode -->
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    .progress-striped {
      background-image: linear-gradient(
        45deg,
        rgba(255,255,255,.25) 25%,
        transparent 25%, transparent 50%,
        rgba(255,255,255,.25) 50%, rgba(255,255,255,.25) 75%,
        transparent 75%, transparent
      );
      background-size: 1rem 1rem;
      animation: progress 1s linear infinite;
    }
    @keyframes progress { from{background-position:1rem 0} to{background-position:0 0} }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 antialiased min-h-screen">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Gerador de Contratos (PDF)</h1>
      <div class="text-sm text-gray-500">Busca literal de <code>{{CHAVES}}</code> (sem AcroForm)</div>
    </header>

    <!-- PASSO 1: escolher empresa -->
    <section id="step-company" class="grid md:grid-cols-2 gap-4">
      <button data-company="InovaInox" class="company-card group rounded-2xl bg-white shadow-card border border-gray-100 p-6 text-left hover:shadow-lg transition">
        <div class="flex items-center gap-3">
          <div class="h-11 w-11 rounded-xl bg-inox/90 text-white grid place-items-center text-lg">II</div>
          <div>
            <div class="font-semibold text-lg">Inova Inox</div>
            <div class="text-gray-500 text-sm">Contrato, OS e Capa (PDF com {{CHAVES}})</div>
          </div>
        </div>
      </button>

      <button data-company="PortoStone" class="company-card group rounded-2xl bg-white shadow-card border border-gray-100 p-6 text-left hover:shadow-lg transition">
        <div class="flex items-center gap-3">
          <div class="h-11 w-11 rounded-xl bg-marble text-white grid place-items-center text-lg">PS</div>
          <div>
            <div class="font-semibold text-lg">Porto Stone</div>
            <div class="text-gray-500 text-sm">Contrato e OS (PDF com {{CHAVES}})</div>
          </div>
        </div>
      </button>
    </section>

    <!-- PASSO 2: preencher e gerar -->
    <section id="step-config" class="hidden mt-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <button id="btn-back" class="text-sm px-3 py-1.5 rounded-lg border hover:bg-gray-50">← Voltar</button>
          <h2 class="text-xl font-semibold"><span id="label-company"></span></h2>
        </div>
        <div class="text-xs text-gray-500">Caminho: <code class="bg-gray-100 px-1 rounded">templates/&lt;Empresa&gt;/&lt;Documento&gt;.pdf</code></div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <!-- Documentos -->
        <div class="rounded-2xl bg-white shadow-card border border-gray-100 p-5">
          <div class="font-medium mb-3">Escolha os documentos</div>
          <div id="doc-options" class="space-y-2 text-sm"></div>
          <p class="text-xs text-gray-500 mt-3">
            Use placeholders literais no PDF, ex.: <code>{{NOME_CONTRATANTE}}</code>, <code>{{VALOR_TOTAL}}</code>.
          </p>
        </div>

        <!-- Campos -->
        <div class="rounded-2xl bg-white shadow-card border border-gray-100 p-5 md:col-span-2">
          <div class="font-medium mb-3">Campos</div>
          <div id="fields" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>

          <div class="mt-4">
            <div class="flex items-center justify-between">
              <div class="font-medium">Campos personalizados</div>
              <button id="add-custom" class="text-sm px-3 py-1.5 rounded-lg border hover:bg-gray-50">+ Adicionar</button>
            </div>
            <div id="custom-fields" class="mt-2 space-y-2"></div>
            <p class="text-xs text-gray-500 mt-1">
              Digite exatamente como no PDF (com chaves), ex.: <b>{{NOME_CONTRATANTE}}</b>.
            </p>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end gap-3 mt-6">
        <button id="btn-generate" class="px-5 py-2.5 rounded-xl bg-inox text-white hover:opacity-95">Gerar PDF(s)</button>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-400 mt-10">
      Templates em <code>templates/InovaInox/</code> e <code>templates/PortoStone/</code> (PDFs com placeholders literais).
    </footer>
  </div>

  <!-- Modal de progresso -->
  <div id="progress-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
      <div class="flex items-center gap-3 mb-3">
        <div class="h-10 w-10 rounded-full bg-inox/90 text-white grid place-items-center font-semibold">%</div>
        <div>
          <h3 class="text-lg font-semibold">Gerando documento…</h3>
          <p id="progress-msg" class="text-xs text-gray-500">Preparando…</p>
        </div>
      </div>
      <div class="w-full h-3 rounded-full bg-gray-200 overflow-hidden">
        <div id="progress-bar" class="h-full w-0 bg-inox progress-striped"></div>
      </div>
      <div class="text-right text-sm mt-2"><span id="progress-num">0</span>%</div>
      <div id="fallback-link" class="hidden mt-4 text-center">
        <a id="manual-link" class="text-inox underline font-medium" href="#" download>Se não baixou, clique aqui para baixar</a>
      </div>
      <div id="diag" class="mt-4 hidden">
        <details class="text-xs text-gray-600">
          <summary class="cursor-pointer font-medium">Diagnóstico</summary>
          <div class="mt-2 space-y-2" id="diag-content"></div>
        </details>
      </div>
    </div>
  </div>

  <!-- Toast sucesso -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 top-6 hidden z-[60]">
    <div class="px-4 py-2 bg-white shadow-lg rounded-xl border flex items-center gap-2">
      <span>✅ Documento gerado!</span>
    </div>
  </div>

  <script>
    // ===== Config =====
    const DOCS = {
      InovaInox: ['Contrato', 'Ordem_de_Servico', 'Capa'],
      PortoStone: ['Contrato', 'Ordem_de_Servico'],
    };

    // Campos base (UI -> coletamos valores; no PDF procuramos {{CHAVE}})
    const COMMON_FIELDS = [
      { key: 'NOME_CONTRATANTE', label: 'Nome do cliente' },
      { key: 'CPF_CONTRATANTE', label: 'CPF/CNPJ' },
      { key: 'ENDERECO_CONTRATANTE', label: 'Endereço' },
      { key: 'TELEFONE_CONTRATANTE', label: 'Telefone' },
      { key: 'TIPO_DE_PROJETO', label: 'Tipo de projeto' },
      { key: 'VALOR_TOTAL', label: 'Valor total' },
      { key: 'DATA_EMISSAO_CONTRATO', label: 'Data de emissão (auto)', placeholder: 'auto' },
    ];

    const FIELDS_BY_DOC = {
      InovaInox: {
        Contrato: [],
        Ordem_de_Servico: [
          { key: 'ORDEM_PRODUCAO', label: 'Ordem de Produção' },
          { key: 'CIDADE', label: 'Cidade' },
          { key: 'VENDEDOR', label: 'Vendedor' },
        ],
        Capa: [
          { key: 'ORDEM_PRODUCAO', label: 'Ordem de Produção' },
          { key: 'ENDERECO_CONTRATANTE_PROJETO', label: 'Endereço do projeto (obra)' },
        ],
      },
      PortoStone: {
        Contrato: [],
        Ordem_de_Servico: [{ key: 'ORDEM_PRODUCAO', label: 'Ordem de Produção' }],
      },
    };

    // ===== Helpers UI =====
    const el  = (s) => document.querySelector(s);
    const els = (s) => Array.from(document.querySelectorAll(s));
    const wrapKey = (k) => `{{${k}}}`;

    // ===== Navegação =====
    let currentCompany = null;

    els('.company-card').forEach((btn) => {
      btn.addEventListener('click', () => {
        currentCompany = btn.dataset.company;
        el('#label-company').textContent = currentCompany === 'InovaInox' ? 'Inova Inox' : 'Porto Stone';
        renderDocOptions();
        renderFields();
        el('#step-company').classList.add('hidden');
        el('#step-config').classList.remove('hidden');
      });
    });
    el('#btn-back').addEventListener('click', () => {
      el('#step-config').classList.add('hidden');
      el('#step-company').classList.remove('hidden');
    });

    function renderDocOptions() {
      const wrap = el('#doc-options'); wrap.innerHTML = '';
      DOCS[currentCompany].forEach((name) => {
        wrap.insertAdjacentHTML('beforeend', `
          <label class="flex items-center gap-2">
            <input type="checkbox" class="accent-inox doc-check" id="doc-${name}" checked />
            <span>${name.replace(/_/g,' ')}</span>
          </label>`);
      });
      els('.doc-check').forEach((c) => c.addEventListener('change', renderFields));
    }

    function getRequiredFields() {
      const map = new Map(COMMON_FIELDS.map((f) => [f.key, f]));
      DOCS[currentCompany].forEach((name) => {
        if (el('#doc-' + name)?.checked) {
          (FIELDS_BY_DOC[currentCompany]?.[name] || []).forEach((f) => map.set(f.key, f));
        }
      });
      return [...map.values()];
    }

    function fieldInput({ key, label, type='text', placeholder='' }) {
      const id = 'f-' + key;
      const labelEl = `<label for="${id}" class="text-sm font-medium">${label} <span class="text-gray-400 text-xs">(${wrapKey(key)})</span></label>`;
      if (type === 'textarea') {
        return `<div class="flex flex-col gap-1">${labelEl}
          <textarea id="${id}" data-key="${key}" rows="4" class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2"></textarea>
        </div>`;
      }
      return `<div class="flex flex-col gap-1">${labelEl}
        <input id="${id}" data-key="${key}" placeholder="${placeholder}" class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2" />
      </div>`;
    }

    function renderFields() {
      const wrap = el('#fields'); wrap.innerHTML = '';
      getRequiredFields().forEach((f) => wrap.insertAdjacentHTML('beforeend', fieldInput(f)));
    }

    el('#add-custom').addEventListener('click', () => {
      el('#custom-fields').insertAdjacentHTML('beforeend', `
        <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
          <input placeholder="Chave (ex.: {{NOME_CONTRATANTE}})" data-type="custom-key" class="col-span-2 rounded-xl border border-gray-300 px-3 py-2" />
          <input placeholder="Valor" data-type="custom-val" class="md:col-span-3 rounded-xl border border-gray-300 px-3 py-2" />
        </div>`);
    });

    function collectData() {
      const data = {};
      els('#fields [data-key]').forEach((inp) => {
        const key = inp.dataset.key;
        let val = (inp.value || '').toString();
        if (key === 'DATA_EMISSAO_CONTRATO' && !val) {
          val = new Date().toLocaleDateString('pt-BR');
        }
        data[wrapKey(key)] = val; // SOMENTE com chaves
      });
      const ks = el('#custom-fields').querySelectorAll('[data-type="custom-key"]');
      ks.forEach((kEl, i) => {
        const rawKey = (kEl.value || '').trim();           // pode vir {{CHAVE}} ou CHAVE
        const val = el('#custom-fields').querySelectorAll('[data-type="custom-val"]')[i].value || '';
        if (!rawKey) return;
        const norm = rawKey.startsWith('{{') ? rawKey : wrapKey(rawKey.replace(/[{}]/g,'').trim());
        data[norm] = val;
      });
      return data;
    }

    // ===== UI Progresso =====
    function showProgress(show = true) {
      const m = el('#progress-modal');
      if (show) { m.classList.remove('hidden'); m.style.display = 'flex'; }
      else { m.classList.add('hidden'); m.style.display = 'none'; }
    }
    function setProgress(pct, msg = '') {
      el('#progress-bar').style.width = `${pct}%`;
      el('#progress-num').textContent = Math.max(0, Math.min(100, Math.round(pct)));
      if (msg) el('#progress-msg').textContent = msg;
    }
    function fireConfetti() {
      const duration = 1200;
      const end = Date.now() + duration;
      (function frame() {
        confetti({ particleCount: 7, angle: 60, startVelocity: 50, spread: 55, origin: { x: 0 } });
        confetti({ particleCount: 7, angle: 120, startVelocity: 50, spread: 55, origin: { x: 1 } });
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }
    function toastOK() {
      const t = el('#toast');
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 1800);
    }

    // ===== Diagnóstico =====
    function setDiag(hidden, html = '') {
      const box = el('#diag');
      const content = el('#diag-content');
      content.innerHTML = html || '';
      box.classList.toggle('hidden', hidden);
    }

    // ===== Utils PDF =====
    const { PDFName, PDFArray } = PDFLib;
    const te = new TextEncoder();
    const td = new TextDecoder('latin1'); // streams podem estar em WinAnsi/Latin1

    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    function pdfEscape(value) {
      // Escapar (), \ para não quebrar strings PDF
      return String(value)
        .replace(/\\/g, '\\\\')
        .replace(/\(/g, '\\(')
        .replace(/\)/g, '\\)')
        .replace(/\r/g, '\\r')
        .replace(/\n/g, '\\n');
    }

    // Tenta inflar; se falhar, trata como texto não comprimido
    function tryInflateToString(u8) {
      try {
        const inflated = pako.inflate(u8);
        return { str: td.decode(inflated), compressed: true };
      } catch (_) {
        // não comprimido (ou outro filtro): tenta decodificar direto como latin1
        try { return { str: td.decode(u8), compressed: false }; }
        catch (e) { return { str: '', compressed: false, error: e }; }
      }
    }

    function deflateOrEncode(str, wasCompressed) {
      return wasCompressed ? pako.deflate(te.encode(str)) : te.encode(str);
    }

    // Substitui APENAS quando o placeholder aparece DENTRO de strings "(...)" do conteúdo
    function replacePlaceholdersInContentString(content, replacements) {
      const counts = {};
      let updated = content;

      for (const [ph, val] of Object.entries(replacements)) {
        // Regex: \( \s* {{CHAVE}} \s* \)
        const re = new RegExp('\\(\\s*' + escapeRegex(ph) + '\\s*\\)', 'g');
        const before = (updated.match(re) || []).length;
        if (before > 0) {
          const escaped = '(' + pdfEscape(val) + ')';
          updated = updated.replace(re, escaped);
        }
        counts[ph] = before;
      }
      return { updated, counts };
    }

    // Altera streams de conteúdo da página (array ou único)
    function getContentsArray(pdfDoc, pageNode) {
      let contents = pageNode.get(PDFName.of('Contents'));
      if (!contents) return null;
      contents = pdfDoc.context.lookup(contents);
      if (contents instanceof PDFArray) return contents;
      // Se for stream único, empacota em array sintético para fluxo uniforme
      const arr = PDFArray.withContext(pdfDoc.context);
      arr.push(pageNode.get(PDFName.of('Contents')));
      return arr;
    }

    async function replacePlaceholdersInPdf(pdfDoc, replacements) {
      const pages = pdfDoc.getPages();
      const globalCounts = {}; // soma por placeholder
      const pagesInfo = [];

      for (let p = 0; p < pages.length; p++) {
        const page = pages[p];
        const pageNode = page.node;
        const contentsArr = getContentsArray(pdfDoc, pageNode);
        if (!contentsArr) continue;

        let pageTotal = 0;
        const perStreamInfo = [];

        for (let i = 0; i < contentsArr.size(); i++) {
          const ref = contentsArr.get(i);
          const stream = pdfDoc.context.lookup(ref);
          if (!stream || !stream.getContents) continue;

          const raw = stream.getContents();
          const { str, compressed } = tryInflateToString(raw);
          if (str === '') continue;

          const { updated, counts } = replacePlaceholdersInContentString(str, replacements);
          // Acumula contagens
          for (const [ph, c] of Object.entries(counts)) {
            globalCounts[ph] = (globalCounts[ph] || 0) + c;
            pageTotal += c;
          }

          if (updated !== str) {
            const newBytes = deflateOrEncode(updated, compressed);
            // cria novo stream e substitui a referência no array
            const newStream = compressed
              ? pdfDoc.context.flateStream(newBytes)
              : pdfDoc.context.stream(newBytes);
            const newRef = pdfDoc.context.register(newStream);
            contentsArr.set(i, newRef);
          }

          perStreamInfo.push({ index: i, replaced: Object.values(counts).reduce((a,b)=>a+b,0) });
        }

        pagesInfo.push({ page: p+1, replaced: pageTotal, perStreamInfo });
      }

      return { globalCounts, pagesInfo };
    }

    // ===== Geração =====
    async function generateOnePDF(company, docName, data) {
      showProgress(true); setDiag(true); setProgress(5, 'Baixando template…');
      const url = `templates/${company}/${docName}.pdf`;

      let bytes;
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Template não encontrado: ' + url);
        bytes = await resp.arrayBuffer();
      } catch (e) {
        setProgress(0, e.message); alert(e.message); showProgress(false); throw e;
      }

      setProgress(35, 'Carregando PDF…');
      const pdfDoc = await PDFLib.PDFDocument.load(bytes);

      // Monta dicionário apenas com chaves no formato {{CHAVE}}
      const replacements = {};
      Object.entries(data).forEach(([k, v]) => {
        const key = k.startsWith('{{') ? k : wrapKey(k.replace(/[{}]/g,'').trim());
        replacements[key] = v == null ? '' : String(v);
      });

      setProgress(60, 'Substituindo placeholders…');
      const { globalCounts, pagesInfo } = await replacePlaceholdersInPdf(pdfDoc, replacements);

      // Diagnóstico
      const notFound = Object.entries(replacements)
        .filter(([k, _]) => (globalCounts[k] || 0) === 0)
        .map(([k]) => k);

      const diagHtml = `
        <div><b>Ocorrências substituídas por chave:</b></div>
        <ul class="list-disc pl-5">
          ${Object.keys(replacements).map(k => `<li><code>${k}</code>: ${globalCounts[k] || 0}</li>`).join('')}
        </ul>
        ${notFound.length ? `<div class="mt-2 text-amber-700"><b>Não encontradas</b>: ${notFound.map(k=>`<code>${k}</code>`).join(', ')}</div>` : ''}
        <div class="mt-2 text-gray-500">
          Dica: se alguma chave estiver com 0, o PDF pode ter fragmentado o texto (ex.: <code>{{NOME_</code> + <code>CONTRATANTE}}</code>).
        </div>
      `;
      setDiag(false, diagHtml);

      setProgress(84, 'Gerando arquivo…');
      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });

      setProgress(95, 'Iniciando download…');
      const urlBlob = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = urlBlob;
      a.download = `${company}_${docName}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      const manual = el('#manual-link');
      const box = el('#fallback-link');
      manual.href = urlBlob;
      manual.download = `${company}_${docName}.pdf`;
      box.classList.remove('hidden');

      setProgress(100, 'Concluído!');
      fireConfetti();
      toastOK();
      setTimeout(() => { showProgress(false); box.classList.add('hidden'); URL.revokeObjectURL(urlBlob); }, 1600);
    }

    // ===== Ação principal =====
    el('#btn-generate').addEventListener('click', async () => {
      if (!currentCompany) { alert('Escolha a empresa primeiro.'); return; }

      const data = collectData();
      const chosen = DOCS[currentCompany].filter((name) => el('#doc-' + name)?.checked);
      if (!chosen.length) { alert('Selecione pelo menos um documento.'); return; }

      for (const docName of chosen) {
        try { await generateOnePDF(currentCompany, docName, data); }
        catch (e) { console.error(e); }
      }
    });
  </script>
</body>
</html>
